pipeline {
    agent any

    parameters {
        gitParameter(name: 'BRANCH_NAME', type: 'BRANCH', defaultValue: 'origin/main', description: 'Choose the branch to build')
    }

    environment {
        IMAGE_NAME = 'fcfb-arceus-dev'
        CONTAINER_NAME = 'FCFB-Arceus-DEV'
        DOCKERFILE = 'Dockerfile_DEV'
        APP_PROPERTIES = './src/main/resources/application.properties'
        DB_URL = credentials('DEV_DB_URL')
        DB_USERNAME = credentials('DB_USERNAME')
        DB_PASSWORD = credentials('DB_PASSWORD')
        JWT_ENCRYPTION_KEY = credentials('JWT_ENCRYPTION_KEY')
        JWT_SECRET = credentials('JWT_SECRET')
        EMAIL_HOST = credentials('EMAIL_HOST')
        EMAIL_PORT = credentials('EMAIL_PORT')
        EMAIL = credentials('EMAIL')
        EMAIL_PASSWORD = credentials('EMAIL_PASSWORD')
        DISCORD_TOKEN = credentials('DEV_REFBOT_DISCORD_TOKEN')
        DISCORD_GUILD_ID = credentials('DEV_DISCORD_GUILD_ID')
        DISCORD_FORUM_CHANNEL_ID = credentials('DEV_DISCORD_FORUM_CHANNEL_ID')
        DISCORD_CLIENT_ID = credentials('DEV_DISCORD_CLIENT_ID')
        DISCORD_CLIENT_SECRET = credentials('DEV_DISCORD_CLIENT_SECRET')
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Checking out branch: ${params.BRANCH_NAME}"
                    sh "git checkout ${params.BRANCH_NAME}"
                }
            }
        }
        stage('Get Version') {
            steps {
                script {
                    // Get the latest Git tag
                    def latestTag = sh(script: "git describe --tags --abbrev=0", returnStdout: true).trim()

                    // If there are no tags, default to 1.0.0
                    if (!latestTag) {
                        latestTag = '1.0.0'
                    }

                    // Print the version
                    echo "Current Version: ${latestTag}"

                    // Set the version to an environment variable for use in later stages
                    env.VERSION = latestTag

                    // Set the build description
                    currentBuild.description = "Version: ${env.VERSION}"
                    currentBuild.displayName = "Build #${env.BUILD_NUMBER} - Version: ${env.VERSION}"
                }
            }
        }
        stage('Stop and Remove Existing Bot') {
            steps {
                script {
                    echo 'Stopping and removing the existing Arceus instance...'
                    sh """
                        docker stop ${CONTAINER_NAME} || echo "Arceus is not running."
                        docker rm ${CONTAINER_NAME} || echo "No old Arceus instance to remove."
                    """
                }
            }
        }

        stage('Test') {
            steps {
                echo 'Setting up test properties...'
                script {
                    def testPropertiesContent = """
                        # Test server config
                        server.port=0
                        
                        # H2 in-memory DB for tests
                        spring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1
                        spring.datasource.driver-class-name=org.h2.Driver
                        spring.datasource.username=sa
                        spring.datasource.password=password
                        
                        # Explicitly override any production database settings
                        spring.datasource.hikari.connection-timeout=20000
                        spring.datasource.hikari.maximum-pool-size=5
                        
                        spring.jpa.hibernate.ddl-auto=create-drop
                        spring.jpa.show-sql=false
                        spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
                        
                        # Force test profile
                        spring.profiles.active=test
                        
                        # Encryption / JWT
                        encryption.key=testkey1234567890
                        encryption.algorithm=aes
                        jwt.secret=testsecret
                        
                        # Mail (dummy)
                        spring.mail.host=localhost
                        spring.mail.port=1025
                        spring.mail.username=test
                        spring.mail.password=test
                        spring.mail.properties.mail.smtp.auth=false
                        spring.mail.properties.mail.smtp.starttls.enable=false
                        
                        # Discord (dummy values)
                        discord.bot.token=dummy
                        discord.bot.url=http://localhost:9999/fcfb_discord
                        discord.guild.id=1
                        discord.forum.channel.id=1
                        discord.client.id=1
                        discord.client.secret=dummy
                        discord.oauth.redirect=http://localhost/dummy
                        
                        # Domain and website URLs (dummy values)
                        domain.url=http://localhost:3000
                        website.url=http://localhost:3000
                        
                        # Images path (dummy value)
                        images.path=./test-images
                        
                        # Disable any production-specific features
                        spring.main.headless=false
                        management.security.enabled=false
                    """.stripIndent()
                    
                    writeFile file: "src/main/resources/application.properties", text: testPropertiesContent
                    
                    echo "Test properties file created:"
                    sh 'cat src/main/resources/application.properties'
                }
                
                echo 'Running tests...'
                sh './gradlew clean test'
            }
        }
        
        stage('Build') {
            steps {
                echo 'Creating the production properties file...'
                script {
                    def propertiesContent = """
                        # Domain configuration
                        domain.url=https://dev.api.fakecollegefootball.com
                        website.url=http://dev.fakecollegefootball.com
                        server.address=0.0.0.0
                        server.port=1313

                        # Images configuration
                        images.path=/app/images

                        # Spring Boot configuration
                        spring.datasource.url=${env.DB_URL}
                        spring.datasource.username=${env.DB_USERNAME}
                        spring.datasource.password=${env.DB_PASSWORD}
                        spring.datasource.driver-class-name=org.mariadb.jdbc.Driver
                        spring.jpa.hibernate.ddl-auto=update
                        spring.jpa.hibernate.dialect=org.hibernate.dialect.MySQL5InnoDBDialect
                        spring.jpa.show-sql=true
                        spring.jackson.property-naming-strategy=SNAKE_CASE
                        spring.main.headless=true
                        management.security.enabled=false

                        # JWT configuration
                        encryption.key=${env.JWT_ENCRYPTION_KEY}
                        encryption.algorithm=aes
                        jwt.secret=${env.JWT_SECRET}

                        # Email configuration
                        spring.mail.host=${env.EMAIL_HOST}
                        spring.mail.port=${env.EMAIL_PORT}
                        spring.mail.username=${env.EMAIL}
                        spring.mail.password=${env.EMAIL_PASSWORD}
                        spring.mail.properties.mail.smtp.auth=true
                        spring.mail.properties.mail.smtp.starttls.enable=true

                        # Health check configuration
                        management.endpoints.web.exposure.include=*
                        management.endpoint.health.show-details=always
                        management.health.defaults.enabled=true
                        management.health.db.enabled=true
                        management.health.diskspace.enabled=true
                        management.health.jvm.enabled=true

                        # Discord configuration
                        discord.bot.token=${env.DISCORD_TOKEN}
                        discord.bot.url=http://51.81.32.234:1312/fcfb_discord
                        discord.guild.id=${env.DISCORD_GUILD_ID}
                        discord.forum.channel.id=${env.DISCORD_FORUM_CHANNEL_ID}
                        discord.client.id=${env.DISCORD_CLIENT_ID}
                        discord.client.secret=${env.DISCORD_CLIENT_SECRET}
                        discord.oauth.redirect=https://dev.api.fakecollegefootball.com/arceus/discord/redirect

                        # Logging configuration
                        logging.level.org.hibernate=warn
                        logging.level.org.hibernate.SQL=warn
                        logging.level.org.hibernate.type.descriptor.sql=warn
                    """.stripIndent()

                    writeFile file: "${env.APP_PROPERTIES}", text: propertiesContent
                }

                echo 'Building the Arceus project...'
                sh './gradlew build -x test'
            }
        }

        stage('Build New Docker Image') {
            steps {
                script {
                    echo 'Building the new Arceus Docker image...'
                    sh """
                        docker build -f ${DOCKERFILE} -t ${IMAGE_NAME}:${DOCKERFILE} .
                    """
                }
            }
        }

        stage('Run New Arceus Container') {
            steps {
                script {
                    echo 'Starting the new Arceus container...'
                    sh """
                        docker run --network="host" -d --restart=always --name ${CONTAINER_NAME} \\
                            -v /var/images:/app/images \\
                            --env-file ${APP_PROPERTIES} \\
                            ${IMAGE_NAME}:${DOCKERFILE}
                    """
                }
            }
        }

        stage('Cleanup Docker System') {
            steps {
                script {
                    echo 'Pruning unused Docker resources...'
                    sh 'docker system prune -a --force'
                }
            }
        }
    }

    post {
        success {
            echo 'Arceus has been successfully deployed!'
        }
        failure {
            echo 'An error occurred during the Arceus deployment.'
        }
    }
}